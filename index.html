<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DTC2 – Registrazione accesso</title>
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#f4f6f8;color:#111}
    .container{max-width:560px;margin:24px auto;padding:0 14px}
    .card{background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:20px}
    .hidden{display:none}
    .pill{display:inline-flex;gap:8px;align-items:center;font-size:12px;color:#666;background:#eef2f7;padding:6px 10px;border-radius:999px;margin-bottom:12px}
    h1{font-size:22px;margin:0 0 6px}
    h2{font-size:18px;margin:0 0 10px}
    .subtitle{font-size:14px;color:#666;margin:8px 0 16px;line-height:1.45}
    .btn{margin-top:16px;width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;background:#0066ff;color:#fff}
    .btn:hover{background:#0052cc}
    .btn:disabled{background:#9bb8ff;cursor:not-allowed}
    .btnSecondary{margin-top:10px;width:100%;padding:12px;border:1px solid #d0d7de;border-radius:12px;font-size:15px;cursor:pointer;background:#fff;color:#111}
    .footer{margin-top:14px;font-size:11px;color:#999;text-align:center}

    label{display:block;font-size:13px;margin:14px 0 6px;color:#333;letter-spacing:.02em}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid #d0d7de;font-size:15px;box-sizing:border-box;background:#fff}
    input:focus{border-color:#0066ff;outline:none;box-shadow:0 0 0 3px rgba(0,102,255,.12)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:460px){.row2{grid-template-columns:1fr}}

    .pdfWrap{border:1px solid #d0d7de;border-radius:10px;overflow:hidden;background:#fff}
    .pdfFrame{width:100%;height:62vh;border:0;display:block;background:#fff}
    @media (max-width:460px){.pdfFrame{height:58vh}}
    .pdfActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .linkBtn{display:inline-block;padding:10px 12px;border:1px solid #d0d7de;border-radius:10px;text-decoration:none;color:#111;background:#fff;font-size:14px}

    .checkboxRow{display:flex;gap:10px;align-items:flex-start;margin-top:14px;padding:12px;border:1px solid #d0d7de;border-radius:10px;background:#fafbfc}
    .checkboxRow input{margin-top:3px;width:auto}
    .checkboxRow .small{font-size:13px;color:#333;line-height:1.35}

    .hint{font-size:12px;color:#666;margin-top:10px}
    .error{margin-top:10px;padding:10px 12px;border-radius:10px;background:#fff3f3;border:1px solid #ffc9c9;color:#8a1f1f;font-size:13px;display:none}

    .successBox{border:1px solid #d0d7de;border-radius:12px;padding:16px;background:#f8fbff;margin-top:14px;line-height:1.5}

    .langGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media (max-width:460px){.langGrid{grid-template-columns:1fr}}
    .langBtn{padding:12px;border:1px solid #d0d7de;border-radius:12px;background:#fff;cursor:pointer;font-size:15px;font-weight:600;text-align:left}
    .langBtn:hover{border-color:#0066ff}
    .langBtn.selected{border-color:#0066ff;box-shadow:0 0 0 3px rgba(0,102,255,.12)}
  </style>
</head>

<body>
  <div class="container">

    <!-- STEP 0: Language -->
    <div class="card" id="step0">
      <div class="pill">Benvenuto</div>
      <h1>BENVENUTO A DTC2</h1>
      <div class="subtitle">Seleziona la lingua per continuare.</div>

      <div class="langGrid">
        <button type="button" class="langBtn" data-lang="it">Italiano</button>
        <button type="button" class="langBtn" data-lang="en">English</button>
        <button type="button" class="langBtn" data-lang="ro">Română</button>
        <button type="button" class="langBtn" data-lang="pl">Polski</button>
        <button type="button" class="langBtn" data-lang="sq">Shqip</button>
        <button type="button" class="langBtn" data-lang="ru">Русский</button>
        <button type="button" class="langBtn" data-lang="uk">Українська</button>
      </div>

      <div class="error" id="errLang">Seleziona una lingua per continuare.</div>
      <button class="btn" id="btnStart" type="button">Continua</button>

      <div class="footer">DTC2 – Access Registration</div>
    </div>

    <!-- STEP 1: PDF + Informativa -->
    <div class="card hidden" id="step1">
      <div class="pill">Step 1 di 2 · Documento</div>
      <h2>Presa visione documento</h2>
      <div class="subtitle">Leggi il documento e conferma la presa visione per continuare.</div>

      <div class="pdfWrap">
        <iframe class="pdfFrame" src="informativa.pdf#view=FitH" title="Informativa PDF"></iframe>
      </div>

      <div class="pdfActions">
        <a class="linkBtn" href="informativa.pdf" target="_blank" rel="noopener">Apri PDF a schermo intero</a>
        <a class="linkBtn" href="informativa.pdf" download>Scarica PDF</a>
      </div>

      <div class="checkboxRow">
        <input type="checkbox" id="presaVisione" />
        <div class="small">Dichiaro di aver preso visione del documento <strong>informativa.pdf</strong>.</div>
      </div>

      <div class="hint">Se il PDF non si visualizza, usa “Apri PDF a schermo intero”.</div>
      <div class="error" id="errStep1">Per continuare devi spuntare la presa visione.</div>

      <button class="btn" id="btnContinua" type="button">Continua</button>
      <button class="btnSecondary" id="btnBackToLang" type="button">Indietro</button>

      <div class="footer">Sistema di registrazione accessi</div>
    </div>

    <!-- STEP 2: Form -->
    <div class="card hidden" id="step2">
      <div class="pill">Step 2 di 2 · Registrazione</div>
      <h2>Registrazione accesso</h2>
      <div class="subtitle">Inserisci i dati richiesti.</div>

      <form id="regForm" novalidate>
        <label>Nome</label>
        <input id="nome" required />

        <label>Cognome</label>
        <input id="cognome" required />

        <label>Telefono</label>
        <input id="telefono" required />

        <label>VRID</label>
        <input id="VRID" required />

        <div class="row2">
          <div>
            <label>Targa Motrice</label>
            <input id="targamotrice" required />
          </div>
          <div>
            <label>Targa Rimorchio</label>
            <input id="targarimorchio" />
          </div>
        </div>

        <div class="error" id="errForm">Compila tutti i campi obbligatori.</div>

        <button class="btn" id="btnInvia" type="submit">Invia registrazione</button>
        <button class="btnSecondary" id="btnIndietro" type="button">Indietro</button>

        <div class="footer">Dati raccolti per finalità organizzative e di sicurezza.</div>
      </form>
    </div>

    <!-- STEP 3: Success -->
    <div class="card hidden" id="step3">
      <div class="pill">Completato</div>
      <h2>La registrazione è avvenuta con successo!</h2>
      <div class="successBox">Rimani in attesa di essere contattato da Amazon per l'ingresso.</div>
      <div class="footer">DTC2 – Access Registration</div>
    </div>

  </div>

  <script>
    // =========================
    // ENDPOINTS (tuoi)
    // =========================
    const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxujsSXJF7elpz7TOCnmc6r843JXPtkx7do0Xi4OFokcpQU5rzdDz5f9mLK0sTe8fMl/exec";
    const SLACK_WEBHOOK_URL  = "https://hooks.slack.com/triggers/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";

    // =========================
    // UI state
    // =========================
    const step0 = document.getElementById("step0");
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");

    const errLang = document.getElementById("errLang");
    const errStep1 = document.getElementById("errStep1");
    const errForm = document.getElementById("errForm");

    const presaVisione = document.getElementById("presaVisione");
    const btnStart = document.getElementById("btnStart");
    const btnContinua = document.getElementById("btnContinua");
    const btnBackToLang = document.getElementById("btnBackToLang");
    const btnIndietro = document.getElementById("btnIndietro");
    const btnInvia = document.getElementById("btnInvia");

    const langButtons = Array.from(document.querySelectorAll(".langBtn"));
    let lingua = null;

    langButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        langButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        lingua = btn.getAttribute("data-lang");
        errLang.style.display = "none";
      });
    });

    btnStart.addEventListener("click", () => {
      if (!lingua) { errLang.style.display = "block"; return; }
      step0.classList.add("hidden");
      step1.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    btnBackToLang.addEventListener("click", () => {
      step1.classList.add("hidden");
      step0.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    btnContinua.addEventListener("click", () => {
      errStep1.style.display = "none";
      if (!presaVisione.checked) { errStep1.style.display = "block"; return; }
      step1.classList.add("hidden");
      step2.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    btnIndietro.addEventListener("click", () => {
      step2.classList.add("hidden");
      step1.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // =========================
    // Submit
    // =========================
    document.getElementById("regForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      errForm.style.display = "none";

      const nome = (document.getElementById("nome").value || "").trim();
      const cognome = (document.getElementById("cognome").value || "").trim();
      const telefono = (document.getElementById("telefono").value || "").trim();
      const VRID = (document.getElementById("VRID").value || "").trim();
      const targamotrice = (document.getElementById("targamotrice").value || "").trim();
      const targarimorchioRaw = (document.getElementById("targarimorchio").value || "").trim();

      if (!nome || !cognome || !telefono || !VRID || !targamotrice) {
        errForm.style.display = "block";
        return;
      }
      if (!lingua) lingua = "it";
      if (!presaVisione.checked) {
        errStep1.style.display = "block";
        step2.classList.add("hidden");
        step1.classList.remove("hidden");
        return;
      }

      btnInvia.disabled = true;
      btnInvia.textContent = "Invio in corso...";

      // Payload canonico (stessi nomi ovunque)
      const payload = {
        timestamp: new Date().toISOString(),
        nome,
        cognome,
        telefono,
        VRID,
        targamotrice,
        targarimorchio: targarimorchioRaw || "-",
        informativa: "SI",
        lingua
      };

      try {
        // A) Sheets: invio robusto via GET ?data=
        const data = encodeURIComponent(JSON.stringify(payload));
        new Image().src = `${SHEETS_WEBAPP_URL}?data=${data}`;

        // B) Slack: notifica workflow (non blocca UX)
        fetch(SLACK_WEBHOOK_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=UTF-8" },
          body: JSON.stringify(payload)
        }).catch(() => {});

        // Success UI
        step2.classList.add("hidden");
        step3.classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });

        // reset device
        e.target.reset();
        presaVisione.checked = false;

      } catch (err) {
        alert("Errore di invio. Verifica connessione e riprova.");
      } finally {
        btnInvia.disabled = false;
        btnInvia.textContent = "Invia registrazione";
      }
    });
  </script>
</body>
</html>
